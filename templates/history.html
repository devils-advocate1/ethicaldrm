<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ethical DRM - Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-r from-gray-900 via-purple-900 to-black text-gray-200 min-h-screen py-12 px-6 flex justify-center items-start">

  <div class="bg-gray-800/80 backdrop-blur-md border border-gray-700 p-8 rounded-2xl shadow-2xl w-full max-w-4xl">
    
    <div class="flex items-center justify-between mb-6 pb-4 border-b border-gray-700">
      <h1 class="text-2xl font-bold text-purple-400 flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        Project Dashboard
      </h1>
      <a href="/" class="text-sm text-purple-400 hover:text-purple-300 transition">&larr; Back to Watermarker</a>
    </div>

    <div class="bg-gray-700/50 p-6 rounded-lg shadow-lg mb-8 border border-gray-700">
      <h2 class="text-xl font-semibold text-purple-300 mb-3">Leakbot Scanner</h2>
      <p class="text-gray-400 mb-4 text-sm">Enter a public URL to scan it for leaks. Check your server terminal for the full report.</p>
      <form id="scan-form" class="flex flex-col sm:flex-row sm:space-x-3">
        <input type="url" id="scan-url" placeholder="https://ibb.co/..." required 
               class="flex-grow block w-full px-3 py-2 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 bg-gray-700 text-gray-200 mb-3 sm:mb-0">
        <button type="submit" id="scan-button" 
                class="inline-flex items-center justify-center px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 disabled:opacity-50">
          Run Scan
        </button>
      </form>
      <div id="scan-result" class="mt-3 text-sm font-medium h-4"></div> </div>
    <h2 class="text-xl font-semibold text-purple-300 mb-4">Watermark History</h2>
    
    <div class="overflow-x-auto rounded-lg border border-gray-700">
      <table class="w-full text-left text-gray-300">
        <thead class="bg-gray-700/60">
          <tr class="text-purple-400">
            <th class="p-4 font-semibold text-sm">User ID</th>
            <th class="p-4 font-semibold text-sm">File</th>
            <th class="p-4 font-semibold text-sm">Signature</th>
            <th class="p-4 font-semibold text-sm">Date</th>
            <th class="p-4 font-semibold text-sm">Download</th>
          </tr>
        </thead>
        <tbody id="historyBody" class="divide-y divide-gray-700">
          <tr>
            <td colspan="5" class="p-4 text-center text-gray-500">Loading history...</td>
          </tr>
        </tbody>
      </table>
    </div>

  </div>

  <script>
    
    
    async function fetchHistory() {
      const tableBody = document.getElementById('historyBody');
      try {
        const response = await fetch('/api/history');
        const sessions = await response.json();

        if (!response.ok) {
           throw new Error('Failed to load history data.');
        }

        if (sessions.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">No watermark sessions found.</td></tr>';
          return;
        }
        
        tableBody.innerHTML = ''; 
        
        sessions.forEach(session => {
          const row = document.createElement("tr");
          row.className = "hover:bg-gray-700/50 transition";
          
          
          const formattedDate = new Date(session.timestamp).toLocaleString('en-US', { 
              year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' 
          });

          
          const downloadUrl = `/download/${session.output_file}`;
          
          row.innerHTML = `
            <td class="p-4 font-mono text-cyan-400">${session.user_id}</td>
            <td class="p-4">${session.output_file}</td>
            <td class="p-4 font-mono text-sm">${session.watermark_signature.substring(0, 16)}...</td>
            <td class="p-4 text-sm">${formattedDate}</td>
            <td class="p-4"><a href="${downloadUrl}" class="text-purple-400 hover:text-purple-300 font-medium" download>Download</a></td>
          `;
          tableBody.appendChild(row);
        });
        
      } catch (error) {
        tableBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-red-500">${error.message}</td></tr>`;
        console.error('Error fetching history:', error);
      }
    }

    
    
    const scanForm = document.getElementById('scan-form');
    const scanUrlInput = document.getElementById('scan-url');
    const scanResultDiv = document.getElementById('scan-result');
    const scanButton = document.getElementById('scan-button');

    scanForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const urlToScan = scanUrlInput.value;

        scanButton.disabled = true;
        scanButton.textContent = 'Scanning...';
        scanResultDiv.textContent = 'Scan started. Check your server terminal...';
        scanResultDiv.className = 'mt-3 text-sm font-medium text-yellow-400'; 

        try {
            const response = await fetch('/run-scan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ url: urlToScan }),
            });
            
            const result = await response.json();

            if (response.ok) {
                scanResultDiv.textContent = result.message; 
                scanResultDiv.className = 'mt-3 text-sm font-medium text-green-400';
            } else {
                scanResultDiv.textContent = `Error: ${result.error}`;
                scanResultDiv.className = 'mt-3 text-sm font-medium text-red-400';
            }

        } catch (error) {
            scanResultDiv.textContent = `Network error: ${error.message}`;
            scanResultDiv.className = 'mt-3 text-sm font-medium text-red-400';
        } finally {
            
            setTimeout(() => {
                 scanButton.disabled = false;
                 scanButton.textContent = 'Run Scan';
                 scanResultDiv.textContent = ''; 
                 scanUrlInput.value = ''; 
            }, 3000);
        }
    });

    
    document.addEventListener('DOMContentLoaded', fetchHistory);
  </script>
</body>
</html>